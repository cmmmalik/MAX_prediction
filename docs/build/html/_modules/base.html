<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>base &mdash; MAX_prediction 1.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> MAX_prediction
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../Compositions.html">Compositions module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Database.html">Database module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../base.html">base module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MAX_prediction</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for base</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span> <span class="k">as</span> <span class="n">itcombinations</span>

<span class="kn">import</span> <span class="nn">cohesive</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">MAX_prediction.Compositions</span> <span class="kn">import</span> <span class="n">Genchemicalsystems</span><span class="p">,</span> <span class="n">Elements</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">CoreSpecie</span>
<span class="kn">from</span> <span class="nn">ase.db.core</span> <span class="kn">import</span> <span class="n">Database</span> <span class="k">as</span> <span class="n">dBcore</span>
<span class="kn">from</span> <span class="nn">chempy</span> <span class="kn">import</span> <span class="n">balance_stoichiometry</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Back</span><span class="p">,</span> <span class="n">init</span>
<span class="kn">from</span> <span class="nn">mse.analysis.chemical_equations</span> <span class="kn">import</span> <span class="n">equation_balancer_v1</span><span class="p">,</span> <span class="n">LinearlydependentMatrix</span>
<span class="kn">from</span> <span class="nn">mse.composition_utils</span> <span class="kn">import</span> <span class="n">MAXcomp</span><span class="p">,</span> <span class="n">EnhancedComposition</span> <span class="k">as</span> <span class="n">Pycomp</span>
<span class="kn">from</span> <span class="nn">mse.ext.materials_project</span> <span class="kn">import</span> <span class="n">SmartMPRester</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">notna</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.composition</span> <span class="kn">import</span> <span class="n">Composition</span>  <span class="k">as</span> <span class="n">Pymcomp</span>

<span class="n">init</span><span class="p">(</span><span class="n">autoreset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="MAXSpecie"><a class="viewcode-back" href="../base.html#base.MAXSpecie">[docs]</a><span class="k">class</span> <span class="nc">MAXSpecie</span><span class="p">(</span><span class="n">CoreSpecie</span><span class="p">):</span>

    <span class="c1"># IO operations must be done in the wrapper class containing many of objects of this class as list</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># database attribute initialization</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MAXSpecie</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sidephases</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_composition</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chemsys</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">formula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formula</span>

    <span class="nd">@formula</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_composition</span> <span class="o">=</span> <span class="n">MAXcomp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown(Non-MAX) formula was entered&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_formula</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="n">Elements</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_genchemsys</span> <span class="o">=</span> <span class="n">Genchemicalsystems</span><span class="p">(</span><span class="n">elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">unique_els</span><span class="p">())</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">get_el_amt_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected an instance of </span><span class="si">{}</span><span class="s2">, but got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">side_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sidephases</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">composition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composition</span><span class="o">.</span><span class="n">comp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxcomposition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composition</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">els</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elementsmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composition</span><span class="o">.</span><span class="n">maxelements</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chemicalsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">maxmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementsmap</span>
        <span class="n">syses</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">maxmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">syses</span>

<div class="viewcode-block" id="MAXSpecie.generate_unique_systems"><a class="viewcode-back" href="../base.html#base.MAXSpecie.generate_unique_systems">[docs]</a>    <span class="k">def</span> <span class="nf">generate_unique_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sizes</span><span class="p">:</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">unique_els</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genchemsys</span><span class="o">.</span><span class="n">unique_combinations_sizes</span><span class="p">(</span><span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MAXSpecies"><a class="viewcode-back" href="../base.html#base.MAXSpecies">[docs]</a><span class="k">class</span> <span class="nc">MAXSpecies</span><span class="p">(</span><span class="n">Species</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formulas</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">establish_connection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
                 <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2707</span><span class="p">,</span> <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">MAXSpecies</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">formulas</span><span class="o">=</span><span class="n">formulas</span><span class="p">,</span> <span class="n">establish_mongo</span><span class="o">=</span><span class="n">establish_connection</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
                                         <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
                                         <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="c1"># reset formulas again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formulas</span>
        <span class="c1"># self._rowsdict = None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">formula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formula</span>

    <span class="nd">@formula</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;formulas contain duplicates&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_composition</span> <span class="o">=</span> <span class="p">[</span><span class="n">MAXSpecie</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_formula</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># @property</span>
    <span class="c1"># def rowsdict(self):</span>
    <span class="c1">#     return self._rowsdict</span>

<div class="viewcode-block" id="MAXSpecies.search_in_asedb"><a class="viewcode-back" href="../base.html#base.MAXSpecies.search_in_asedb">[docs]</a>    <span class="k">def</span> <span class="nf">search_in_asedb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asedb</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">dBcore</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;ASE database has already been searched and relevant entries are already accessible, &quot;</span>
                          <span class="s2">&quot;I am exiting!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">rowsdict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MAXSpecies</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">search_in_asedb</span><span class="p">(</span><span class="n">asedb</span><span class="o">=</span><span class="n">asedb</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rowsdict</span></div>

<div class="viewcode-block" id="MAXSpecies.search_set_rows"><a class="viewcode-back" href="../base.html#base.MAXSpecies.search_set_rows">[docs]</a>    <span class="k">def</span> <span class="nf">search_set_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asedb</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">dBcore</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filterfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rowsdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_in_asedb</span><span class="p">(</span><span class="n">asedb</span><span class="o">=</span><span class="n">asedb</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filterfunc</span><span class="p">:</span>
            <span class="n">rowsdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="n">filterfunc</span><span class="p">,</span> <span class="n">rows</span><span class="p">)]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">rows</span> <span class="ow">in</span> <span class="n">rowsdict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">if</span> <span class="n">rowsdict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_rows</span><span class="p">(</span><span class="n">rowsdict</span><span class="o">=</span><span class="n">rowsdict</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXSpecies.refined_formulas_search_rows"><a class="viewcode-back" href="../base.html#base.MAXSpecies.refined_formulas_search_rows">[docs]</a>    <span class="k">def</span> <span class="nf">refined_formulas_search_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asedb</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">dBcore</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">rowsdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_in_asedb</span><span class="p">(</span><span class="n">asedb</span><span class="o">=</span><span class="n">asedb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refine_formulas</span><span class="p">(</span><span class="n">rowsdict</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_refine_formulas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rowsdict</span><span class="p">):</span>
        <span class="n">rrows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">toremoveindex</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">rowsdict</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Found more than one rows for a composition </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">toremoveindex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">row</span>
            <span class="n">rrows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>

        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">toremoveindex</span><span class="p">]</span>
        <span class="c1"># safe inspect again</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">f</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">formula</span>

<div class="viewcode-block" id="MAXSpecies.set_rows"><a class="viewcode-back" href="../base.html#base.MAXSpecies.set_rows">[docs]</a>    <span class="k">def</span> <span class="nf">set_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rowsdict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">rrows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">rowsdict</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Found more than one rows for a composition </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Debug:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">formula:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">Row:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">row</span>
            <span class="n">rrows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rows</span> <span class="o">=</span> <span class="n">rrows</span></div>

<div class="viewcode-block" id="MAXSpecies.generate_unique_systems"><a class="viewcode-back" href="../base.html#base.MAXSpecies.generate_unique_systems">[docs]</a>    <span class="k">def</span> <span class="nf">generate_unique_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">specie</span><span class="o">.</span><span class="n">generate_unique_systems</span><span class="p">(</span><span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">)</span> <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composition</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="MAXAnalyzer"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer">[docs]</a><span class="k">class</span> <span class="nc">MAXAnalyzer</span><span class="p">(</span><span class="n">MAXSpecies</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">formulas</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
                 <span class="n">maxdb</span><span class="p">:</span> <span class="n">dBcore</span> <span class="ow">or</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">elementdb</span><span class="p">:</span> <span class="n">dBcore</span> <span class="ow">or</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">establish_connection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
                 <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2707</span><span class="p">,</span>
                 <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">decimtol</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
                 <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_formation_colname</span> <span class="o">=</span> <span class="s2">&quot;uncorr_formation_energy_per_formula&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_calculate_formation_energy</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sp_remove_MAX</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sp_append_with_MAX</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reactions_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxdb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elementdb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_asedb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sp_asedb_filterfunc</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span> <span class="o">=</span> <span class="n">decimtol</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">MAXAnalyzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">formulas</span><span class="o">=</span><span class="n">formulas</span><span class="p">,</span> <span class="n">establish_connection</span><span class="o">=</span><span class="n">establish_connection</span><span class="p">,</span>
                                          <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                                          <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="c1"># set unique elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uqelements</span> <span class="o">=</span> <span class="n">Elements</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_genchsys</span> <span class="o">=</span> <span class="n">Genchemicalsystems</span><span class="p">(</span><span class="n">elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_elements</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">elementdb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elementdb</span> <span class="o">=</span> <span class="n">elementdb</span>
        <span class="k">if</span> <span class="n">maxdb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxdb</span> <span class="o">=</span> <span class="n">maxdb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asedb</span> <span class="o">=</span> <span class="n">maxdb</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sst</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;formulas=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">)]</span>
        <span class="n">sst</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;totalelements=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_elements</span><span class="p">)]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">(</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">MAXAnalyzer</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sst</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">energies_per_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">comp</span><span class="o">.</span><span class="n">energy_per_formula</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">comp</span><span class="o">.</span><span class="n">elementsmap</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">side_phase_calculate_formation_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_calculate_formation_energy</span>

    <span class="nd">@side_phase_calculate_formation_energy</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">side_phase_calculate_formation_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Whether to re-calculate the side formation energy of the side phases&quot;</span>
              <span class="s2">&quot; (for mp database used usually to avoid any correction)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected only boolean type values, instead received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_calculate_formation_energy</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chemicalsystems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">pr</span><span class="o">.</span><span class="n">chemicalsystem</span> <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">pr</span><span class="o">.</span><span class="n">elements</span> <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxdb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maxdb</span>

    <span class="nd">@maxdb</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">maxdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">dBcore</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setdb</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maxdb</span> <span class="o">=</span> <span class="n">db</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">side_phase_asedb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_asedb</span>

    <span class="nd">@side_phase_asedb</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">side_phase_asedb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="p">[</span><span class="n">dBcore</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This database must contain only MAX phases, that may (not) participate in competition.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ddb</span> <span class="ow">in</span> <span class="n">db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setdb</span><span class="p">(</span><span class="n">ddb</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_asedb</span> <span class="o">=</span> <span class="n">db</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elementdb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementdb</span>

    <span class="nd">@elementdb</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">elementdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">dBcore</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setdb</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elementdb</span> <span class="o">=</span> <span class="n">db</span>

    <span class="k">def</span> <span class="nf">_setdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">dBcore</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">dBcore</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;</span><span class="si">{}</span><span class="s2">&#39;, expected &#39;</span><span class="si">{}</span><span class="s2">&#39; or &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dBcore</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">side_phase_remove_MAX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sp_remove_MAX</span>

    <span class="nd">@side_phase_remove_MAX</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">side_phase_remove_MAX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;expected a </span><span class="si">{}</span><span class="s2"> value, instead got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sp_remove_MAX</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">side_phase_append_with_MAX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sp_append_with_MAX</span>

    <span class="nd">@side_phase_append_with_MAX</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">side_phase_append_with_MAX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;expected a </span><span class="si">{}</span><span class="s2"> value, instead got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sp_append_with_MAX</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sp_asedb_filterfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sp_asedb_filterfunc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uqelements</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uqelements</span><span class="o">.</span><span class="n">els</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reactions_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactions_df</span>

    <span class="nd">@reactions_df</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">reactions_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected &#39;</span><span class="si">{}</span><span class="s2">&#39;, instead received &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reactions_df</span> <span class="o">=</span> <span class="n">df</span>

<div class="viewcode-block" id="MAXAnalyzer.create_set_maxphase_dataframe"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.create_set_maxphase_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">create_set_maxphase_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;energy_per_formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energies_per_formula</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">)</span>
        <span class="n">mapp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_mapping</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mapp</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;chemsys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chemicalsystems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_df</span> <span class="o">=</span> <span class="n">df</span></div>


<div class="viewcode-block" id="MAXAnalyzer.Entries_to_df"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.Entries_to_df">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">Entries_to_df</span><span class="p">(</span><span class="n">entries</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">en_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;formation_energy_per_atom&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">entry</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_composition</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">en1_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">energy_per_atom</span> <span class="o">*</span> <span class="n">entry</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_composition</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">([(</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;e_above_hull&quot;</span><span class="p">],</span> <span class="n">en_func</span><span class="p">(</span><span class="n">entry</span><span class="p">),</span> <span class="n">en1_func</span><span class="p">(</span><span class="n">entry</span><span class="p">),</span>
                         <span class="n">entry</span><span class="o">.</span><span class="n">correction</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">sys</span><span class="p">,</span> <span class="n">ens</span> <span class="ow">in</span> <span class="n">entries</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">ens</span><span class="p">],</span>
                       <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">,</span> <span class="s2">&quot;chemsys&quot;</span><span class="p">,</span> <span class="s2">&quot;mp-id&quot;</span><span class="p">,</span> <span class="s2">&quot;e_above_hull&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;formation_energy_per_formula&quot;</span><span class="p">,</span> <span class="s2">&quot;total_energy_per_formula_mat&quot;</span><span class="p">,</span> <span class="s2">&quot;correction&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">side_phases_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_df</span>

    <span class="nd">@side_phases_df</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">side_phases_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid value type </span><span class="si">{}</span><span class="s2"> was provided, Expected </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_df</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">side_phase_formation_colname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_formation_colname</span>

    <span class="nd">@side_phase_formation_colname</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">side_phase_formation_colname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;uncorr_formation_energy_per_formula&quot;</span><span class="p">,</span> <span class="s2">&quot;calc_formation_energy_per_formula&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Got unexpected value &#39;</span><span class="si">{}</span><span class="s2">&#39;. Allowed values are &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">allowed</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_formation_colname</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_df</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">side_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_df</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span>

<div class="viewcode-block" id="MAXAnalyzer.calcadd_total_energies_into_side_df"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.calcadd_total_energies_into_side_df">[docs]</a>    <span class="k">def</span> <span class="nf">calcadd_total_energies_into_side_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># Enfunc = lambda pdrow: calculate_total_energy_from_formation_energy(pdrow.phase,</span>
        <span class="c1">#                                                                     en=-pdrow.formation_energy_per_formula,</span>
        <span class="c1">#                                                                     elemental_energies=</span>
        <span class="c1">#                                                                     {el: elemental_energies[el] for el in</span>
        <span class="c1">#                                                                      Pycomp(</span>
        <span class="c1">#                                                                          pdrow.phase).get_el_amt_dict().keys()})</span>
        <span class="n">Pandasutils</span><span class="o">.</span><span class="n">add_total_energyfrom_formation_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="o">=</span><span class="n">elemental_energies</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.append_elements_side_df"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.append_elements_side_df">[docs]</a>    <span class="k">def</span> <span class="nf">append_elements_side_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_df</span> <span class="o">=</span> <span class="n">Pandasutils</span><span class="o">.</span><span class="n">append_elementalenergy_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">,</span>
                                                                    <span class="n">total_elements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_elements</span><span class="p">,</span>
                                                                    <span class="n">elemental_energies</span><span class="o">=</span><span class="n">elemental_energies</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.predict"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">elementfilterfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sizes</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="n">mpkey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">check_online</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">solvers_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">remove_common_sp</span><span class="p">:</span> <span class="nb">bool</span> <span class="ow">or</span> <span class="s2">&quot;mp&quot;</span> <span class="ow">or</span> <span class="s2">&quot;ase&quot;</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">maxrowsfilterfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">searchmethod_dbnew_sp</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">asedb_final_filter_function_sp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">asedb_final_general_function_sp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method that predicts the stabilities of MAX phases.</span>
<span class="sd">        &#39;sp&#39; contanning arguments are passed to side phase related methods.</span>
<span class="sd">        </span>
<span class="sd">        :param elementfilterfunc:</span>
<span class="sd">        :param sizes: the combination of reactants that are allowed .ToDO: should be set internally based on the number of chemical</span>
<span class="sd">        elements in the compound.</span>
<span class="sd">        :param mpkey:str, mp key in case check_online is set to True.</span>
<span class="sd">        :param check_online:bool, default True, to look online for the entries (valid for mp). It uses an old api of materials project.</span>
<span class="sd">        Currently the usage is depracated.</span>
<span class="sd">        :param solvers_check:</span>
<span class="sd">        :param remove_common_sp:</span>
<span class="sd">        :param maxrowsfilterfunc:</span>
<span class="sd">        :param searchmethod_dbnew_sp: bool, default True,</span>
<span class="sd">         whether to use the new method of searching the ase databases for the side phases. In this method,</span>
<span class="sd">          a list of ase databases are screeened for relevant chemical system containing ase rows.</span>
<span class="sd">        :param asedb_final_filter_function_sp: function that will be called inside filter().</span>
<span class="sd">        ( for side phases (rows) obtainef frm ase databases)</span>
<span class="sd">        :param asedb_final_general_function_sp: function that  will just be called directly on the rows.</span>
<span class="sd">         (for side phases (rows) obtained from ae database)</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_predict</span><span class="p">(</span><span class="n">elementfilterfunc</span><span class="o">=</span><span class="n">elementfilterfunc</span><span class="p">,</span>
                           <span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span> <span class="n">mpkey</span><span class="o">=</span><span class="n">mpkey</span><span class="p">,</span>
                           <span class="n">check_online</span><span class="o">=</span><span class="n">check_online</span><span class="p">,</span>
                           <span class="n">solvers_check</span><span class="o">=</span><span class="n">solvers_check</span><span class="p">,</span>
                           <span class="n">remove_common_sp</span><span class="o">=</span><span class="n">remove_common_sp</span><span class="p">,</span>
                           <span class="n">maxrowsfilterfunc</span><span class="o">=</span><span class="n">maxrowsfilterfunc</span><span class="p">,</span>
                           <span class="n">search_dbnew_sp</span><span class="o">=</span><span class="n">searchmethod_dbnew_sp</span><span class="p">,</span>
                           <span class="n">asedb_filter_func_sp</span><span class="o">=</span><span class="n">asedb_final_filter_function_sp</span><span class="p">,</span>
                           <span class="n">asedb_general_func_sp</span><span class="o">=</span><span class="n">asedb_final_general_function_sp</span><span class="p">)</span>
        <span class="c1"># self._predict()</span>
        <span class="n">stable</span><span class="p">,</span> <span class="n">unstable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_prediction</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stable</span><span class="p">,</span> <span class="n">unstable</span></div>

    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calcadd_enthalpyreactions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_enthalpyperatom</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insert_mpids</span><span class="p">()</span>

<div class="viewcode-block" id="MAXAnalyzer.do_prediction"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.do_prediction">[docs]</a>    <span class="k">def</span> <span class="nf">do_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convienent method, calls _predict method, which actually does the calculation of enthalpies and</span>
<span class="sd">        post-calculation insertion of energies into the reactions pandas dataframe and returns stable and unstable array</span>
<span class="sd">        of phases&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_predict</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stable_unstable</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_get_stable_unstable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="o">.</span><span class="n">enthalpy</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">unstable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;product_0&quot;</span><span class="p">][</span><span class="n">bol</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">stable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;product_0&quot;</span><span class="p">][</span><span class="o">~</span><span class="n">bol</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">stable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stable</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unstable</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prediction Results&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reactions&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unstable&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">unstable</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stable&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">stable</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stable</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">unstable</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stable</span><span class="p">,</span> <span class="n">unstable</span>

<div class="viewcode-block" id="MAXAnalyzer.setup_predict"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.setup_predict">[docs]</a>    <span class="k">def</span> <span class="nf">setup_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elementfilterfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">sizes</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                      <span class="n">mpkey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">check_online</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">solvers_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">remove_common_sp</span><span class="p">:</span> <span class="nb">bool</span> <span class="ow">or</span> <span class="s2">&quot;ase&quot;</span> <span class="ow">or</span> <span class="s2">&quot;mp&quot;</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">maxrowsfilterfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">search_dbnew_sp</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">asedb_filter_func_sp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">asedb_general_func_sp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ASEDatabase_lookup</span><span class="p">(</span><span class="n">elementfilterfunc</span><span class="o">=</span><span class="n">elementfilterfunc</span><span class="p">,</span> <span class="n">maxrowsfilterfunc</span><span class="o">=</span><span class="n">maxrowsfilterfunc</span>
                                <span class="p">)</span>  <span class="c1"># local ase database search for MAX and Elements</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_sidephase</span><span class="p">(</span><span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span> <span class="n">mpkey</span><span class="o">=</span><span class="n">mpkey</span><span class="p">,</span>
                             <span class="n">check_online</span><span class="o">=</span><span class="n">check_online</span><span class="p">,</span>
                             <span class="n">remove_common_sp</span><span class="o">=</span><span class="n">remove_common_sp</span><span class="p">,</span>
                             <span class="n">search_dbnew</span><span class="o">=</span><span class="n">search_dbnew_sp</span><span class="p">,</span>
                             <span class="n">asedb_filter_func</span><span class="o">=</span><span class="n">asedb_filter_func_sp</span><span class="p">,</span>
                             <span class="n">asedb_general_func</span><span class="o">=</span><span class="n">asedb_general_func_sp</span><span class="p">)</span>  <span class="c1"># mongo database and online MP databae search  and local ase db database(s)</span>
        <span class="c1"># for side phases</span>
        <span class="c1"># reactions, reaction2 = self.balancer_inside(solvers_check=solvers_check)  # get the balanced reactions</span>
        <span class="c1"># if reaction2:</span>
        <span class="c1">#     raise NotImplementedError(&quot;Unable to handle if both balancing solvers give different result&quot;)</span>
        <span class="c1">#</span>
        <span class="c1"># self.reactions_df = reactions</span>
        <span class="c1"># self.insert_energy_column()</span>
        <span class="c1"># if self.verbosity &gt;= 1:</span>
        <span class="c1">#     print(&quot;Reactions&quot;)</span>
        <span class="c1">#     print(reactions)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="n">solvers_check</span><span class="o">=</span><span class="n">solvers_check</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.balance"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.balance">[docs]</a>    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solvers_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

        <span class="n">reactions</span><span class="p">,</span> <span class="n">reaction2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balancer_inside</span><span class="p">(</span><span class="n">solvers_check</span><span class="o">=</span><span class="n">solvers_check</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reaction2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unable to handle if both balancing solvers give different result&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span> <span class="o">=</span> <span class="n">reactions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_energy_column</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reactions&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">reactions</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.getdf_sidephase_elements_MPDatabase"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.getdf_sidephase_elements_MPDatabase">[docs]</a>    <span class="k">def</span> <span class="nf">getdf_sidephase_elements_MPDatabase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elementfilter</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_search_elements_mp</span><span class="p">(</span><span class="n">sort_by_e_above_hull</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">elementfilter</span><span class="o">=</span><span class="n">elementfilter</span><span class="p">)</span>
        <span class="n">el_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">to_dataframe_entries</span><span class="p">()</span>
        <span class="n">el_df</span><span class="p">[</span><span class="s2">&quot;uncorr_total_energy_pf_mp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">el_df</span><span class="p">[</span><span class="s2">&quot;uncorr_total_energy_per_formula&quot;</span><span class="p">]</span>
        <span class="n">el_df</span><span class="p">[</span><span class="s2">&quot;uncorr_total_energy_pa_mp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">el_df</span><span class="p">[</span><span class="s2">&quot;uncorr_total_energy_per_atom&quot;</span><span class="p">]</span>
        <span class="n">el_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;uncorr_total_energy_per_formula&quot;</span><span class="p">,</span> <span class="s2">&quot;uncorr_total_energy_per_atom&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">el_df</span><span class="p">[</span><span class="s2">&quot;total_energy_per_formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">el_df</span><span class="p">[</span><span class="s2">&quot;uncorr_total_energy_pa_mp&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">el_df</span><span class="p">[</span><span class="s2">&quot;uncorr_total_energy_pa_mp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">el_df</span><span class="p">[</span><span class="s2">&quot;uncorr_total_energy_pf_mp&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">el_df</span></div>

<div class="viewcode-block" id="MAXAnalyzer.setup_sidephase_MPDatabase"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.setup_sidephase_MPDatabase">[docs]</a>    <span class="k">def</span> <span class="nf">setup_sidephase_MPDatabase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span><span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="kc">None</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
                                   <span class="n">check_online</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                   <span class="n">mpkey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                   <span class="n">elementfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">MPDatabase_lookup</span><span class="p">(</span><span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span> <span class="n">mpkey</span><span class="o">=</span><span class="n">mpkey</span><span class="p">,</span> <span class="n">check_online</span><span class="o">=</span><span class="n">check_online</span><span class="p">)</span>
        <span class="c1">#filter out e_above hull greater than zero</span>
        <span class="n">Pandasutils</span><span class="o">.</span><span class="n">filter_e_above_hull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">[</span><span class="s2">&quot;total_energy_per_formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">[</span><span class="s2">&quot;uncorr_total_energy_pf_mp&quot;</span><span class="p">]</span>

        <span class="c1">#adding elements here</span>
        <span class="n">el_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdf_sidephase_elements_MPDatabase</span><span class="p">(</span><span class="n">elementfilter</span><span class="o">=</span><span class="n">elementfilter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.setup_sidephase"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.setup_sidephase">[docs]</a>    <span class="k">def</span> <span class="nf">setup_sidephase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">sizes</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                        <span class="n">mpkey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">check_online</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">remove_common_sp</span><span class="p">:</span> <span class="nb">bool</span> <span class="ow">or</span> <span class="s2">&quot;mp&quot;</span> <span class="ow">or</span> <span class="s2">&quot;ase&quot;</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">search_dbnew</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">asedb_filter_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">asedb_general_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks for the side phases by chemical systems based on provided sizes(list, default 2 and 3 ),</span>
<span class="sd">        in the local database first. If an entry is not in the local database, search is done in the online materials</span>
<span class="sd">        project database(if check_online is set to True, default=True). Additionally, The calculation of</span>
<span class="sd">        formation energy relative to elemntary can also be performed which uses uncorrected total energies of side phase and</span>
<span class="sd">        elemental references. This makes sure that no correction is added into the formation energies, contrary to</span>
<span class="sd">        formation energies (&#39;uncorr_formation_energy_per_formula&#39;) obtained from materials project API always containing correction contributions.</span>

<span class="sd">        :param</span>



<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">MPDatabase_lookup</span><span class="p">(</span><span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span> <span class="n">mpkey</span><span class="o">=</span><span class="n">mpkey</span><span class="p">,</span> <span class="n">check_online</span><span class="o">=</span><span class="n">check_online</span><span class="p">,</span> <span class="p">)</span>
        <span class="c1"># filter out e_above hull greater than zero</span>
        <span class="n">Pandasutils</span><span class="o">.</span><span class="n">filter_e_above_hull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After filter&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phase_calculate_formation_energy</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phase_formation_colname</span> <span class="o">==</span> <span class="s2">&quot;calc_formation_energy_per_formula&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Re-calculating formation energy of side phases&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_calculate_formation_energy_sidephases</span><span class="p">()</span>

        <span class="c1"># peratom energies, since for molecules,</span>
        <span class="c1"># per formula energies, will be numberofatomsinamolecule*energy_per_atom, just a hack at the moment</span>
        <span class="c1"># TODo: Convert the cohesive function to take proper molecular elements instead of atomic molecules,</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_total_energy_frmformation_sp</span><span class="p">(</span><span class="n">add_elements_df</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>

        <span class="c1">## get extra max dataframe</span>
        <span class="c1"># extra_sp_df = self.search_get_df_sp_chemsys_asedb(db=self.side_phase_asedb, exclude_overlap_rows=True)</span>
        <span class="c1"># get commons before going forward</span>
        <span class="c1"># if remove_common_sp:</span>
        <span class="c1">#     print(&quot;Removing common&quot;)</span>
        <span class="c1">#     formulafunc = lambda x: Pymcomp(x).reduced_formula</span>
        <span class="c1">#     sp_phases = self.side_phases_df.phase.apply(formulafunc)</span>
        <span class="c1">#     extra_sp_ph = extra_sp_df.phase.apply(formulafunc)</span>
        <span class="c1">#     if remove_common_sp == &quot;mp&quot; or remove_common_sp == True:</span>
        <span class="c1">#         common = self.side_phases_df.loc[(sp_phases.isin(extra_sp_ph))]</span>
        <span class="c1">#         if self.verbosity &gt;= 1:</span>
        <span class="c1">#             print(&quot;Common side phase compositions are being dropped from MP(derived phases):&quot;)</span>
        <span class="c1">#             print(common)</span>
        <span class="c1">#         self.side_phases_df.drop(common.index, inplace=True)</span>
        <span class="c1">#     elif remove_common_sp == &quot;ase&quot;:</span>
        <span class="c1">#         common = extra_sp_df.loc[(extra_sp_ph.isin(sp_phases))]</span>
        <span class="c1">#         if self.verbosity &gt;= 1:</span>
        <span class="c1">#             print(&quot;Common side phase compositions begin dropped from ase(local database):&quot;)</span>
        <span class="c1">#             print(common)</span>
        <span class="c1">#         extra_sp_df.drop(common.index, inplace=True)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         warnings.warn(&quot;Common side phases were not touched... I did nothing. Please specify either True, &quot;</span>
        <span class="c1">#                       &quot;&#39;ase&#39;, &#39;mp&#39;&quot;)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phase_asedb</span><span class="p">:</span>
            <span class="n">side_phase_asedb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phase_asedb</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">side_phase_asedb</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">side_phase_asedb</span> <span class="o">=</span> <span class="p">[</span><span class="n">side_phase_asedb</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">search_dbnew</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">extra_sp_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">sp_db</span> <span class="ow">in</span> <span class="n">side_phase_asedb</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_side_phases_from_asedb</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">sp_db</span><span class="p">,</span>
                                                            <span class="n">exclude_overlap_rows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">remove_common</span><span class="o">=</span><span class="n">remove_common_sp</span><span class="p">)</span>

                    <span class="n">extra_sp_df</span> <span class="o">=</span> <span class="n">extra_sp_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

                <span class="c1"># it makes sense to get the lowest energy--- sort and then get the the lowest energy</span>
                <span class="c1">#  ---assuming all the phases have same spacegroup!!!!!</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sorting the extra(other MAX dataframe) and then picking the lowest energy value by default.-----&quot;</span><span class="p">)</span>
                <span class="n">extra_sp_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_per_atom&quot;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">extra_sp_df</span><span class="p">)</span>
                <span class="c1">#### select the higest</span>
                <span class="n">phases</span> <span class="o">=</span> <span class="n">extra_sp_df</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

                <span class="n">extra_lowest_sp_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
                   <span class="n">extra_lowest_sp_df</span> <span class="o">=</span> <span class="n">extra_lowest_sp_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extra_sp_df</span><span class="p">[</span><span class="n">extra_sp_df</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ph</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">extra_sp_df</span> <span class="o">=</span> <span class="n">extra_lowest_sp_df</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using new method of searching dblst&quot;</span><span class="p">)</span>

                <span class="n">extra_sp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_side_phases_from_asedblst</span><span class="p">(</span> <span class="n">dblst</span><span class="o">=</span><span class="n">side_phase_asedb</span><span class="p">,</span>
                                                                   <span class="n">exclude_overlap_rows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                   <span class="n">remove_common</span><span class="o">=</span><span class="n">remove_common_sp</span><span class="p">,</span>
                                                                   <span class="n">final_filter_function</span><span class="o">=</span><span class="n">asedb_filter_func</span><span class="p">,</span>
                                                                   <span class="n">final_general_function</span><span class="o">=</span><span class="n">asedb_general_func</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding extra side phases --- (only MAX like) ----(obtained from ase database to pandas dataframe):&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">extra_sp_df</span><span class="p">)</span>
            <span class="n">extra_sp_df</span><span class="p">[</span><span class="s2">&quot;spacegroup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;P6_3/mmc&quot;</span>
            <span class="c1"># have to remove common compositions that match with MAX.df from extra side phase df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_common_max_from_spdf</span><span class="p">(</span><span class="n">side_phase_df</span><span class="o">=</span><span class="n">extra_sp_df</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extra_sp_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final side phases:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.setup_side_phase_explicit"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.setup_side_phase_explicit">[docs]</a>    <span class="k">def</span> <span class="nf">setup_side_phase_explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbslst</span><span class="p">:</span><span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1">#search each db list</span>

        <span class="n">sph_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">dbslst</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_permute_chemical_sytems_asedb</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
            <span class="n">sph_df</span> <span class="o">=</span> <span class="n">sph_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sidephase_aserows_to_df</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rr</span><span class="p">]),</span>
                                   <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phase_asedb</span><span class="p">:</span>
            <span class="n">other_max_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_get_df_sp_chemsys_asedb</span><span class="p">(</span><span class="n">exclude_overlap_rows</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sph_df</span> <span class="o">=</span> <span class="n">sph_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other_max_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">sph_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_sidephase_df</span><span class="p">(</span><span class="n">sph_df</span><span class="p">)</span>
        <span class="c1">#elements also</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_elements_side_df</span><span class="p">(</span><span class="n">elemental_energies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_elemental_energies</span><span class="p">())</span></div>

<div class="viewcode-block" id="MAXAnalyzer.find_side_phases_from_asedb"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.find_side_phases_from_asedb">[docs]</a>    <span class="k">def</span> <span class="nf">find_side_phases_from_asedb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">dBcore</span><span class="p">,</span> <span class="n">remove_common</span><span class="p">:</span><span class="nb">bool</span> <span class="ow">or</span> <span class="s2">&quot;mp&quot;</span> <span class="ow">or</span> <span class="s2">&quot;ase&quot;</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">exclude_overlap_rows</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

        <span class="n">extra_sp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_get_df_sp_chemsys_asedb</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">exclude_overlap_rows</span><span class="o">=</span><span class="n">exclude_overlap_rows</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remove_common</span><span class="p">:</span> <span class="c1"># remove common</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_do_remove_common</span><span class="p">(</span><span class="n">extra_sp_df</span><span class="o">=</span><span class="n">extra_sp_df</span><span class="p">,</span> <span class="n">remove_common</span><span class="o">=</span><span class="n">remove_common</span><span class="p">)</span>
            <span class="c1"># formulafunc = lambda x: Pymcomp(x).reduced_formula</span>
            <span class="c1"># sp_phases = self.side_phases_df.phase.apply(formulafunc)</span>
            <span class="c1"># extra_sp_ph = extra_sp_df.phase.apply(formulafunc)</span>
            <span class="c1"># if remove_common == &quot;mp&quot; or remove_common == True:</span>
            <span class="c1">#     common = self.side_phases_df.loc[(sp_phases.isin(extra_sp_ph))]</span>
            <span class="c1">#     if self.verbosity &gt;= 1:</span>
            <span class="c1">#         print(&quot;Common side phase compositions are being dropped from MP(derived phases):&quot;)</span>
            <span class="c1">#         print(common)</span>
            <span class="c1">#     self.side_phases_df.drop(common.index, inplace=True)</span>
            <span class="c1"># elif remove_common == &quot;ase&quot;:</span>
            <span class="c1">#     common = extra_sp_df.loc[(extra_sp_ph.isin(sp_phases))]</span>
            <span class="c1">#     if self.verbosity &gt;= 1:</span>
            <span class="c1">#         print(&quot;Common side phase compositions begin dropped from ase(local database):&quot;)</span>
            <span class="c1">#         print(common)</span>
            <span class="c1">#     extra_sp_df.drop(common.index, inplace=True)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     warnings.warn(&quot;Common side phases were not touched... I did nothing. Please specify either True, &quot;</span>
            <span class="c1">#                   &quot;&#39;ase&#39;, &#39;mp&#39;&quot;)</span>

        <span class="k">return</span> <span class="n">extra_sp_df</span></div>

    <span class="k">def</span> <span class="nf">_do_remove_common</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_sp_df</span><span class="p">,</span> <span class="n">remove_common</span><span class="p">:</span> <span class="nb">bool</span> <span class="ow">or</span> <span class="s1">&#39;mp&#39;</span> <span class="ow">or</span> <span class="s1">&#39;ase&#39;</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

           <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing common&quot;</span><span class="p">)</span>

           <span class="n">formulafunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Pymcomp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">reduced_formula</span>
           <span class="n">sp_phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">formulafunc</span><span class="p">)</span>
           <span class="n">extra_sp_ph</span> <span class="o">=</span> <span class="n">extra_sp_df</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">formulafunc</span><span class="p">)</span>

           <span class="k">if</span> <span class="n">remove_common</span> <span class="o">==</span> <span class="s2">&quot;mp&quot;</span> <span class="ow">or</span> <span class="n">remove_common</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
               <span class="n">common</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">sp_phases</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">extra_sp_ph</span><span class="p">))]</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Common side phase compositions are being dropped from MP(derived phases):&quot;</span><span class="p">)</span>
                   <span class="nb">print</span><span class="p">(</span><span class="n">common</span><span class="p">)</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
           <span class="k">elif</span> <span class="n">remove_common</span> <span class="o">==</span> <span class="s2">&quot;ase&quot;</span><span class="p">:</span>
               <span class="n">common</span> <span class="o">=</span> <span class="n">extra_sp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">extra_sp_ph</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sp_phases</span><span class="p">))]</span>
               <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Common side phase compositions begin dropped from ase(local database):&quot;</span><span class="p">)</span>
                   <span class="nb">print</span><span class="p">(</span><span class="n">common</span><span class="p">)</span>
               <span class="n">extra_sp_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Common side phases were not touched... I did nothing. Please specify either True, &quot;</span>      
                             <span class="s2">&quot;&#39;ase&#39;, &#39;mp&#39;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MAXAnalyzer.find_side_phases_from_asedblst"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.find_side_phases_from_asedblst">[docs]</a>    <span class="k">def</span> <span class="nf">find_side_phases_from_asedblst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dblst</span><span class="p">:</span> <span class="p">[</span><span class="n">dBcore</span><span class="p">],</span> <span class="n">remove_common</span><span class="p">:</span><span class="nb">bool</span> <span class="ow">or</span> <span class="s1">&#39;mp&#39;</span> <span class="ow">or</span> <span class="s1">&#39;ase&#39;</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">exclude_overlap_rows</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">final_filter_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">final_general_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
                                       <span class="n">kwargs</span><span class="o">=</span><span class="p">()):</span>

        <span class="n">extra_sp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_get_df_sp_chemsys_asedblst</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">dblst</span><span class="p">,</span> <span class="n">exclude_overlap_rows</span><span class="o">=</span><span class="n">exclude_overlap_rows</span><span class="p">,</span>
                                                              <span class="n">final_filter_function</span><span class="o">=</span><span class="n">final_filter_function</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                                              <span class="n">final_general_function</span><span class="o">=</span><span class="n">final_general_function</span><span class="p">,</span>
                                                              <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remove_common</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_remove_common</span><span class="p">(</span><span class="n">extra_sp_df</span><span class="p">,</span> <span class="n">remove_common</span><span class="o">=</span><span class="n">remove_common</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">extra_sp_df</span></div>

<div class="viewcode-block" id="MAXAnalyzer.add_calculate_formation_energy_sidephases"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.add_calculate_formation_energy_sidephases">[docs]</a>    <span class="k">def</span> <span class="nf">add_calculate_formation_energy_sidephases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">elemental_entry_energies</span> <span class="o">=</span> <span class="p">{</span><span class="n">specie</span><span class="o">.</span><span class="n">formula</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">specie</span><span class="o">.</span><span class="n">energy_per_atom_in_entry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span> <span class="n">decimtol</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">composition</span><span class="p">}</span>  <span class="c1"># peratom energies is safe parameter for</span>
        <span class="c1"># both molecules and bulk for calculating formation energies.</span>
        <span class="n">Form_en</span> <span class="o">=</span> <span class="n">Pandasutils</span><span class="o">.</span><span class="n">add_calculate_formation_energy_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">,</span>
                                                                <span class="n">elemental_energies</span><span class="o">=</span><span class="n">elemental_entry_energies</span><span class="p">,</span>
                                                                <span class="n">en_colname</span><span class="o">=</span><span class="s2">&quot;uncorr_total_energy_pf_mp&quot;</span><span class="p">,</span>
                                                                <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">[</span><span class="s2">&quot;calc_formation_energy_per_formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Form_en</span></div>

<div class="viewcode-block" id="MAXAnalyzer.calculate_total_energy_frmformation_sp"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.calculate_total_energy_frmformation_sp">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_total_energy_frmformation_sp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">add_elements_df</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

        <span class="n">elemental_energies</span> <span class="o">=</span> <span class="p">{</span><span class="n">specie</span><span class="o">.</span><span class="n">formula</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">specie</span><span class="o">.</span><span class="n">energy_per_atom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">)</span> <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">composition</span><span class="p">}</span>

        <span class="n">Pandasutils</span><span class="o">.</span><span class="n">add_total_energyfrom_formation_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">,</span>
                                                      <span class="n">elemental_energies</span><span class="o">=</span><span class="n">elemental_energies</span><span class="p">,</span>
                                                      <span class="n">formation_colname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phase_formation_colname</span><span class="p">,</span>
                                                      <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_elements_df</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_elements_side_df</span><span class="p">(</span><span class="n">elemental_energies</span><span class="o">=</span><span class="n">elemental_energies</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.get_elemental_energies"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.get_elemental_energies">[docs]</a>    <span class="k">def</span> <span class="nf">get_elemental_energies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">elemental_energies</span> <span class="o">=</span> <span class="p">{</span><span class="n">specie</span><span class="o">.</span><span class="n">formula</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">specie</span><span class="o">.</span><span class="n">energy_per_atom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">)</span> <span class="k">for</span> <span class="n">specie</span> <span class="ow">in</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">composition</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">elemental_energies</span></div>

<div class="viewcode-block" id="MAXAnalyzer.ASEDatabase_lookup"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.ASEDatabase_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">ASEDatabase_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elementfilterfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxrowsfilterfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">correction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,):</span>
        <span class="c1"># search in the databses</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxdb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">search_set_rows</span><span class="p">(</span><span class="n">asedb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxdb</span><span class="p">,</span> <span class="n">filterfunc</span><span class="o">=</span><span class="n">maxrowsfilterfunc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;MAX phases are already obtained from the database&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementdb</span>
            <span class="n">elrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_elements</span><span class="p">(</span><span class="n">elementfilterfunc</span><span class="o">=</span><span class="n">elementfilterfunc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">set_rows</span><span class="p">(</span><span class="n">rowsdict</span><span class="o">=</span><span class="n">elrows</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Elements are already obtained from the database&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">correction</span><span class="p">:</span>
            <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Corrections to the total energy from database row are not implemented&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;MAX dataframe was already created --skipping the creation&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_set_maxphase_dataframe</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_df</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.search_elements"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.search_elements">[docs]</a>    <span class="k">def</span> <span class="nf">search_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elementfilterfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">elrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">search_in_asedb</span><span class="p">(</span><span class="n">asedb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elementdb</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">elementfilterfunc</span><span class="p">:</span>
            <span class="n">elrows</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">elementfilterfunc</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">elrows</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">elrows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;More than one rows of element: </span><span class="si">{}</span><span class="s2"> are found in the database.&quot;</span>
                                     <span class="s2">&quot;Supply elementfilterfunction&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">el</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">elrows</span></div>

<div class="viewcode-block" id="MAXAnalyzer.set_search_elements_mp"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.set_search_elements_mp">[docs]</a>    <span class="k">def</span> <span class="nf">set_search_elements_mp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_by_e_above_hull</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">elementfilter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Searches the local mongo database for elements.It will look for entries matching a given formula.</span>
<span class="sd">        Be aware that the that the database connection must be established before using this method.</span>
<span class="sd">        :param sort_by_e_above_hull: bool, default True. It will sort the final entries based on energy above hull</span>
<span class="sd">        :param elementfilter: : func, default None. a function that will be called upon list of entries to make a</span>
<span class="sd">        selection for a specific entry.</span>
<span class="sd">        :return: dict of ChemicalEntries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elentries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">search_in_mpdb</span><span class="p">(</span><span class="n">sort_by_e_above_hull</span><span class="o">=</span><span class="n">sort_by_e_above_hull</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">elementfilter</span><span class="p">:</span>
            <span class="n">elentries</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">elementfilter</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">entries</span> <span class="ow">in</span> <span class="n">elentries</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">elentries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;More than one rows of element: </span><span class="si">{}</span><span class="s2"> are found in the MP Database.&quot;</span>
                                     <span class="s2">&quot;Supply elementfilterfunction&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">el</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Elements</span><span class="o">.</span><span class="n">set_entries</span><span class="p">(</span><span class="n">elentries</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.search_setdf_in_mpdb"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.search_setdf_in_mpdb">[docs]</a>    <span class="k">def</span> <span class="nf">search_setdf_in_mpdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_by_e_above_hull</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">max_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_in_mpdb</span><span class="p">(</span><span class="n">sort_by_e_above_hull</span><span class="o">=</span><span class="n">sort_by_e_above_hull</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">en</span> <span class="ow">in</span> <span class="n">max_entries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">en</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">max_entries</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">en</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_entries</span><span class="p">(</span><span class="n">max_entries</span><span class="p">)</span>

        <span class="n">max_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe_entries</span><span class="p">()</span>
        <span class="n">max_df</span><span class="p">[</span><span class="s2">&quot;energy_per_formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_df</span><span class="p">[</span><span class="s2">&quot;uncorr_total_energy_per_formula&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_df</span> <span class="o">=</span> <span class="n">max_df</span></div>

<div class="viewcode-block" id="MAXAnalyzer.MPDatabase_lookup"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.MPDatabase_lookup">[docs]</a>    <span class="k">def</span> <span class="nf">MPDatabase_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">mpkey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_online</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">collection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Establish connection to the database first&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">collection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchset_sidephase_df</span><span class="p">(</span><span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span> <span class="n">mpkey</span><span class="o">=</span><span class="n">mpkey</span><span class="p">,</span> <span class="n">check_online</span><span class="o">=</span><span class="n">check_online</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.balancer_inside"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.balancer_inside">[docs]</a>    <span class="k">def</span> <span class="nf">balancer_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">solvers_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">feasible</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">feasible_solver2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># if not max_df:</span>
        <span class="c1">#     max_df = self.maxphase_to_pandas_frame()</span>
        <span class="c1"># func = lambda value: &quot;-&quot;.join(sorted(value.split(&quot;-&quot;)))</span>
        <span class="c1"># chemsys = max_df[&quot;chemsys&quot;].apply(func)</span>
        <span class="c1"># max_ph = max_df[&quot;phase&quot;]</span>
        <span class="c1"># side_ph = self.side_phases_df.phase</span>
        <span class="c1"># side_ph_chemsys = side_ph[&quot;chemsys&quot;].apply(func)</span>
        <span class="n">chemsys_series</span><span class="p">,</span> <span class="n">side_chemsys_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_chempy_dataframes</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">:</span>
            <span class="n">els</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">elements</span>

            <span class="c1"># max_side_phases = max_df.phase.loc[(max_ph != pr.formula) &amp; (chemsys == &quot;-&quot;.join(sorted(els)))]</span>
            <span class="c1"># s_ph = side_ph.loc[(side_ph_chemsys.str.contains(elsmap[&quot;M&quot;]))</span>
            <span class="c1">#                     | (side_ph_chemsys == elsmap[&quot;A&quot;])</span>
            <span class="c1">#                     | (side_ph_chemsys == elsmap[&quot;X&quot;])</span>
            <span class="c1">#                     | (side_ph_chemsys == &quot;-&quot;.join(sorted([elsmap[&quot;A&quot;], elsmap[&quot;X&quot;]])))]</span>

            <span class="c1"># s_ph = np.append(s_ph, max_side_phases)</span>
            <span class="c1"># s_ph = np.unique(s_ph)</span>
            <span class="n">s_ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_side_phases_comp_base</span><span class="p">(</span><span class="n">chemsys_series</span><span class="o">=</span><span class="n">chemsys_series</span><span class="p">,</span>
                                                    <span class="n">side_chemsys_series</span><span class="o">=</span><span class="n">side_chemsys_series</span><span class="p">,</span>
                                                    <span class="n">pr</span><span class="o">=</span><span class="n">pr</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combine_compounds_multisize</span><span class="p">(</span><span class="n">s_ph</span><span class="p">,</span> <span class="n">combination_size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">necessary</span><span class="o">=</span><span class="n">els</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trying to balance: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reac</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">coeffs</span> <span class="o">=</span> <span class="n">equation_balancer_v1</span><span class="p">(</span><span class="n">reactants</span><span class="o">=</span><span class="n">reac</span><span class="p">,</span>
                                                     <span class="n">products</span><span class="o">=</span><span class="p">[</span><span class="n">pr</span><span class="o">.</span><span class="n">formula</span><span class="p">],</span>
                                                     <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                     <span class="n">depence_check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Balanced: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>
                    <span class="n">reactants</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">vv</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">reactants</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found negative Coefficient&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="s2">&quot;Reactants:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reactants</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="n">pseudo_reac</span> <span class="o">=</span> <span class="p">[((</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tipe</span><span class="p">,</span> <span class="n">counter</span><span class="p">),</span> <span class="n">key</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s2">&quot;coeff_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">counter</span><span class="p">),</span> <span class="n">specie</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                                   <span class="k">for</span> <span class="n">specie</span><span class="p">,</span> <span class="n">tipe</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;reactant&quot;</span><span class="p">,</span> <span class="s2">&quot;product&quot;</span><span class="p">])</span>
                                   <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specie</span><span class="p">)]</span>
                    <span class="n">pseudo_reac</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">pseudo_reac</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">])</span>
                    <span class="n">feasible</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pseudo_reac</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">LinearlydependentMatrix</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">solvers_check</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">balance_stoichiometry</span><span class="p">(</span><span class="n">reactants</span><span class="o">=</span><span class="n">reac</span><span class="p">,</span> <span class="n">products</span><span class="o">=</span><span class="p">[</span><span class="n">pr</span><span class="o">.</span><span class="n">formula</span><span class="p">])</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">Back</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;The chempy solver balanced the reaction&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Balanced: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>
                            <span class="n">reactants</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">vv</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">reactants</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found negative Coefficient&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="s2">&quot;Reactants:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reactants</span><span class="p">))</span>
                                <span class="k">continue</span>
                            <span class="n">pseudo_reac</span> <span class="o">=</span> <span class="p">[((</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tipe</span><span class="p">,</span> <span class="n">counter</span><span class="p">),</span> <span class="n">key</span><span class="p">),</span>
                                            <span class="p">(</span><span class="s2">&quot;coeff_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">counter</span><span class="p">),</span> <span class="n">specie</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                                           <span class="k">for</span> <span class="n">specie</span><span class="p">,</span> <span class="n">tipe</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;reactant&quot;</span><span class="p">,</span> <span class="s2">&quot;product&quot;</span><span class="p">])</span>
                                           <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specie</span><span class="p">)]</span>
                            <span class="n">pseudo_reac</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">pseudo_reac</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">])</span>
                            <span class="n">feasible_solver2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pseudo_reac</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex2</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">ex2</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;Couldn&#39;t balance by both solvers&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">feasible_solver2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">feasible</span><span class="p">),</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">feasible_solver2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;Reactions unbalanced by first solver &#39;</span><span class="si">{}</span><span class="s2">&#39; are also unbalanced by second solver &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">equation_balancer_v1</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">balance_stoichiometry</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">feasible</span><span class="p">),</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_sort_chempy_dataframes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sortfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)))</span>
        <span class="c1"># max dataframe</span>
        <span class="n">chemsys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_df</span><span class="o">.</span><span class="n">chemsys</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sortfunc</span><span class="p">)</span>
        <span class="c1"># side phase dataframe</span>
        <span class="n">side_chemsys_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="o">.</span><span class="n">chemsys</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">sortfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chemsys</span><span class="p">,</span> <span class="n">side_chemsys_series</span>

    <span class="k">def</span> <span class="nf">_find_side_phases_comp_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">chemsys_series</span><span class="p">,</span>
                                    <span class="n">side_chemsys_series</span><span class="p">,</span>
                                    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">formula</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">pr</span><span class="p">:</span> <span class="n">MAXSpecie</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

        <span class="k">assert</span> <span class="n">pr</span> <span class="ow">or</span> <span class="n">index</span> <span class="ow">or</span> <span class="n">formula</span>
        <span class="n">max_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_df</span>
        <span class="n">side_ph_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="o">.</span><span class="n">phase</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pr</span><span class="p">:</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="n">formula</span><span class="p">]</span>
        <span class="n">els</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">elementsmap</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">elements</span>


        <span class="c1"># s_max_ph = side_ph_series.loc[side_chemsys_series == &quot;-&quot;.join(sorted(elements))]</span>

        <span class="c1"># s_ph = side_ph_phase.loc[(side_ph_phase.str.contains(els[&quot;M&quot;]))</span>
        <span class="c1">#                           | (side_chemsys_series == els[&quot;A&quot;])</span>
        <span class="c1">#                           | (side_chemsys_series == els[&quot;X&quot;])</span>
        <span class="c1">#                           | (side_chemsys_series == &quot;-&quot;.join(sorted([els[&quot;A&quot;], els[&quot;X&quot;]])))]</span>

        <span class="c1"># s_ph = side_ph_phase.loc[(side_ph_phase.str.contains(els[&quot;M&quot;]))</span>
        <span class="c1">#                           | (side_chemsys_series == els[&quot;A&quot;])</span>
        <span class="c1">#                           | (side_chemsys_series == els[&quot;X&quot;])</span>
        <span class="c1">#                           | (side_chemsys_series == &quot;-&quot;.join(sorted([els[&quot;A&quot;], els[&quot;X&quot;]])))]</span>


        <span class="c1"># for MAX phase only</span>
        <span class="k">assert</span> <span class="n">els</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">els</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">els</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span>

        <span class="n">s_ph</span> <span class="o">=</span> <span class="n">side_ph_phase</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">side_chemsys_series</span> <span class="o">==</span> <span class="n">els</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">side_chemsys_series</span> <span class="o">==</span> <span class="n">els</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">side_chemsys_series</span> <span class="o">==</span> <span class="n">els</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">])</span>
                                 <span class="o">|</span> <span class="p">(</span><span class="n">side_chemsys_series</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">els</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">],</span> <span class="n">els</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]])))</span> <span class="c1"># M-A</span>
                                 <span class="o">|</span> <span class="p">(</span><span class="n">side_chemsys_series</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">els</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">],</span> <span class="n">els</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]])))</span> <span class="c1">#M-X</span>
                                 <span class="o">|</span> <span class="p">(</span><span class="n">side_chemsys_series</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">els</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="n">els</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]])))</span>
                                 <span class="o">|</span> <span class="p">(</span><span class="n">side_chemsys_series</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">elements</span><span class="p">)))]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phase_append_with_MAX</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------Apending with MAX-like phases from max dataframe---------------&quot;</span><span class="p">)</span>
            <span class="n">max_side_phases</span> <span class="o">=</span> <span class="n">max_df</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">max_df</span><span class="o">.</span><span class="n">phase</span> <span class="o">!=</span> <span class="n">pr</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">chemsys_series</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">elements</span><span class="p">)))]</span>
            <span class="n">s_ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_ph</span><span class="p">,</span> <span class="n">max_side_phases</span><span class="p">)</span>

        <span class="n">s_ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">s_ph</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Side phases being used for a MAX phase: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">s_ph</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s_ph</span>

<div class="viewcode-block" id="MAXAnalyzer.find_side_phases_comp"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.find_side_phases_comp">[docs]</a>    <span class="k">def</span> <span class="nf">find_side_phases_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">formula</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">):</span>
        <span class="n">chemsys_series</span><span class="p">,</span> <span class="n">side_chemsys_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_chempy_dataframes</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_side_phases_comp_base</span><span class="p">(</span><span class="n">chemsys_series</span><span class="o">=</span><span class="n">chemsys_series</span><span class="p">,</span>
                                                <span class="n">side_chemsys_series</span><span class="o">=</span><span class="n">side_chemsys_series</span><span class="p">,</span>
                                                <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                                                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.df_compare_solvers_balance"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.df_compare_solvers_balance">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">df_compare_solvers_balance</span><span class="p">(</span><span class="n">df_series</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>

        <span class="n">reactants</span> <span class="o">=</span> <span class="n">df_series</span><span class="p">[[</span><span class="s2">&quot;reactant_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]]</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">df_series</span><span class="p">[[</span><span class="s2">&quot;product_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)]]</span>
        <span class="n">reactants</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reactants</span> <span class="k">if</span> <span class="n">notna</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="n">products</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">products</span> <span class="k">if</span> <span class="n">notna</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bal</span> <span class="o">=</span> <span class="n">equation_balancer_v1</span><span class="p">(</span><span class="n">reactants</span><span class="o">=</span><span class="n">reactants</span><span class="p">,</span>
                                       <span class="n">products</span><span class="o">=</span><span class="n">products</span><span class="p">,</span>
                                       <span class="n">depence_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">LinearlydependentMatrix</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span></div>

    <span class="c1"># Database related functions</span>

<div class="viewcode-block" id="MAXAnalyzer.entries_by_system_database"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.entries_by_system_database">[docs]</a>    <span class="k">def</span> <span class="nf">entries_by_system_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mpkey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_online</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                   <span class="o">**</span><span class="n">entrykwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function checks online database only if there is not entry for a given chemical system in the local database</span>
<span class="sd">        ToDo: ask user if the online database check up should be done as well, if a new entry is found that should be added in the side phases.</span>
<span class="sd">        :param sizes:</span>
<span class="sd">        :param mpkey:</span>
<span class="sd">        :param check_online:</span>
<span class="sd">        :param entrykwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Entries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">check_online</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">mpkey</span>
            <span class="n">smp</span> <span class="o">=</span> <span class="n">SmartMPRester</span><span class="p">(</span><span class="n">mpkey</span><span class="o">=</span><span class="n">mpkey</span><span class="p">)</span>
            <span class="n">smp</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">syes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_unique_systems</span><span class="p">(</span><span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">):</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_entries_system</span><span class="p">(</span><span class="n">syes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">entrykwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;System </span><span class="si">{}</span><span class="s2"> does not exist in the local database</span><span class="se">\n</span><span class="s2">will search in mp online database if&quot;</span>
                              <span class="s2">&quot;check_online is set to True&quot;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">syes</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">check_online</span><span class="p">:</span>
                    <span class="n">entries</span> <span class="o">=</span> <span class="n">smp</span><span class="o">.</span><span class="n">get_entries</span><span class="p">(</span><span class="n">syes</span><span class="p">,</span> <span class="n">property_data</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;formation_energy_per_atom&quot;</span><span class="p">,</span>
                                                                   <span class="s2">&quot;spacegroup&quot;</span><span class="p">,</span>
                                                                   <span class="s2">&quot;e_above_hull&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">entries</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found the entries for system&quot;</span><span class="p">)</span>
            <span class="n">Entries</span><span class="p">[</span><span class="n">syes</span><span class="p">]</span> <span class="o">=</span> <span class="n">entries</span>

        <span class="k">if</span> <span class="n">check_online</span><span class="p">:</span>
            <span class="n">smp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">Entries</span></div>

<div class="viewcode-block" id="MAXAnalyzer.set_side_phase_df"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.set_side_phase_df">[docs]</a>    <span class="k">def</span> <span class="nf">set_side_phase_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">Entries</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                          <span class="n">remove_max_comps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note: There is a bug in API (v.2020.0) of materialsproject in pymatgen. The correction_energy,correction etc.</span>
<span class="sd">        is always found to be zero which is not the actual case.</span>
<span class="sd">        Therefore, the &#39;uncorr&#39; and &#39;corr&#39; energies were found to be always equal. Before,</span>
<span class="sd">        &#39;uncorr_formation_energy_per_formula&#39; was being used for calculating total energies of side phases.</span>
<span class="sd">        Due to the aforementioned bug, formation energy is calculated using uncorrected total energy relative</span>
<span class="sd">         to materials project elemental reference energies.</span>
<span class="sd">         This quantity is denoted by &#39;calc_formation_energy_per_formula&#39;.</span>

<span class="sd">        :param Entries:</span>
<span class="sd">        :param decimtol:</span>
<span class="sd">        :param remove_max_comps:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For non Mp database, stability is considered as energy above hull (e_above_hull)&quot;</span><span class="p">)</span>
        <span class="n">tstentry</span> <span class="o">=</span> <span class="n">Entries</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">Entries</span><span class="p">))][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;mp-&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">tstentry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">):</span> <span class="c1"># means we have mp-type data</span>
            <span class="n">side_phase_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;e_above_hull&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stability&quot;</span><span class="p">)),</span> <span class="n">entry</span><span class="o">.</span><span class="n">correction_per_atom</span><span class="p">,</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;formation_energy_per_atom&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta_e&quot;</span><span class="p">)),</span>
                 <span class="nb">round</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;formation_energy_per_atom&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta_e&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="n">entry</span><span class="o">.</span><span class="n">correction_per_atom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">((</span><span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;formation_energy_per_atom&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta_e&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="n">entry</span><span class="o">.</span><span class="n">correction_per_atom</span><span class="p">)</span> <span class="o">*</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_composition</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">uncorrected_energy_per_atom</span> <span class="o">*</span> <span class="n">entry</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_composition</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">uncorrected_energy_per_atom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">),</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spacegroup&quot;</span><span class="p">)[</span><span class="s2">&quot;symbol&quot;</span><span class="p">],</span>
                <span class="p">)</span> <span class="k">for</span> <span class="n">sys</span><span class="p">,</span> <span class="n">entries</span> <span class="ow">in</span> <span class="n">Entries</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">],</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">,</span> <span class="s2">&quot;chemsys&quot;</span><span class="p">,</span> <span class="s2">&quot;mp-id&quot;</span><span class="p">,</span> <span class="s2">&quot;e_above_hull&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_per_atom&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;corr_formation_energy_per_atom&quot;</span><span class="p">,</span> <span class="s2">&quot;uncorr_formation_energy_per_atom&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;uncorr_formation_energy_per_formula&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;uncorr_total_energy_pf_mp&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;uncorr_total_energy_pa_mp&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;spacegroup&quot;</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">side_phase_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">entry_id</span><span class="p">,</span>  <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stability&quot;</span><span class="p">),</span>
                  <span class="n">entry</span><span class="o">.</span><span class="n">correction_per_atom</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta_e&quot;</span><span class="p">),</span>
                  <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta_e&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">entry</span><span class="o">.</span><span class="n">correction_per_atom</span><span class="p">,</span>
                  <span class="nb">round</span><span class="p">((</span><span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta_e&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">entry</span><span class="o">.</span><span class="n">correction_per_atom</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">entry</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_composition</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">),</span>
                  <span class="n">entry</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spacegroup&quot;</span><span class="p">),</span>
                    <span class="p">)</span> <span class="k">for</span> <span class="n">sys</span><span class="p">,</span> <span class="n">entries</span> <span class="ow">in</span> <span class="n">Entries</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">],</span>

                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">,</span> <span class="s2">&quot;chemsys&quot;</span><span class="p">,</span> <span class="s2">&quot;mp-id&quot;</span><span class="p">,</span> <span class="s2">&quot;e_above_hull&quot;</span><span class="p">,</span> <span class="s2">&quot;correction_per_atom&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;corr_formation_energy_per_atom&quot;</span><span class="p">,</span> <span class="s2">&quot;uncorr_formation_energy_per_atom&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;uncorr_formation_energy_per_formula&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;spacegroup&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">remove_max_comps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_df</span> <span class="o">=</span> <span class="n">side_phase_df</span>
            <span class="k">return</span>

        <span class="c1"># formulafunc = lambda x: Pymcomp(x).reduced_composition.iupac_formula.replace(&quot; &quot;, &quot;&quot;)</span>
        <span class="c1"># phases = side_phase_df.phase.apply(formulafunc)</span>
        <span class="c1"># sg = side_phase_df.spacegroup</span>
        <span class="c1"># if self.side_phase_remove_MAX:</span>
        <span class="c1">#     if self.max_df is not None:</span>
        <span class="c1">#         max_ph = self.max_df.phase.apply(formulafunc)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         max_ph = np.asarray([Pycomp(i).iupac_formula for i in self.formula])</span>
        <span class="c1">#</span>
        <span class="c1">#     common = side_phase_df.loc[(phases.isin(max_ph)) &amp; ((sg == &quot;P6_3/mmc&quot;) | (sg == &quot;P63/mmc&quot;))]  # drop overlapping compositions with MAX</span>
        <span class="c1">#</span>
        <span class="c1">#     if self.verbosity &gt;= 1:</span>
        <span class="c1">#         print(&quot;Removing common MAX Compositions:&quot;)</span>
        <span class="c1">#         print(common)</span>
        <span class="c1">#</span>
        <span class="c1">#     side_phase_df.drop(common.index, inplace=True)</span>
        <span class="c1">#     side_phase_df.reset_index(drop=True, inplace=True)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">do_remove_common_max_from_spdf</span><span class="p">(</span><span class="n">side_phase_df</span><span class="o">=</span><span class="n">side_phase_df</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_df</span> <span class="o">=</span> <span class="n">side_phase_df</span></div>

<div class="viewcode-block" id="MAXAnalyzer.do_remove_common_max_from_spdf"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.do_remove_common_max_from_spdf">[docs]</a>    <span class="k">def</span> <span class="nf">do_remove_common_max_from_spdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side_phase_df</span> <span class="p">:</span> <span class="n">DataFrame</span><span class="p">):</span>

        <span class="n">formulafunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Pymcomp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">reduced_composition</span><span class="o">.</span><span class="n">iupac_formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="n">side_phase_df</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">formulafunc</span><span class="p">)</span>
        <span class="n">sg</span> <span class="o">=</span> <span class="n">side_phase_df</span><span class="o">.</span><span class="n">spacegroup</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">max_ph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_df</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">formulafunc</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
          <span class="n">max_ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">Pycomp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">iupac_formula</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">])</span>

        <span class="n">common</span> <span class="o">=</span> <span class="n">side_phase_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">phases</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">max_ph</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">sg</span> <span class="o">==</span> <span class="s2">&quot;P6_3/mmc&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sg</span> <span class="o">==</span> <span class="s2">&quot;P63/mmc&quot;</span><span class="p">))]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing common MAX Compositions:&quot;</span><span class="p">)</span>
          <span class="nb">print</span><span class="p">(</span><span class="n">common</span><span class="p">)</span>

        <span class="n">side_phase_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">side_phase_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.search_sidephase_chemsys_asedb"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.search_sidephase_chemsys_asedb">[docs]</a>    <span class="k">def</span> <span class="nf">search_sidephase_chemsys_asedb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                       <span class="n">db</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">dBcore</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                       <span class="n">exclude_overlap_rows</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">searchargs</span><span class="p">,</span> <span class="o">**</span><span class="n">searchkwargs</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Searches the phases acting as side phases in the ase database, based on the chemical system of MAX . In other words,</span>
<span class="sd">        searches for  any  compositions containing all of the elements present in the chemical system</span>
<span class="sd">        defined by the given MAX phase(including other MAX phases) in the  local ase database.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phase_asedb</span>
        <span class="n">side_Rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_chemical_system_asedb</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="o">*</span><span class="n">searchargs</span><span class="p">,</span> <span class="o">**</span><span class="n">searchkwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="ow">and</span> <span class="n">exclude_overlap_rows</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">):</span>
                <span class="n">uqid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">unique_id</span>
                <span class="n">side_Rows</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">side_Rows</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">!=</span> <span class="n">uqid</span><span class="p">]</span>

        <span class="c1">#filtering here</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sp_asedb_filterfunc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------Side phase filter function was provided----------&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">ros</span> <span class="ow">in</span> <span class="n">side_Rows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">side_Rows</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_asedb_filterfunc</span><span class="p">,</span> <span class="n">ros</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">side_Rows</span></div>

<div class="viewcode-block" id="MAXAnalyzer.search_sidephase_chemsys_asedblst"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.search_sidephase_chemsys_asedblst">[docs]</a>    <span class="k">def</span> <span class="nf">search_sidephase_chemsys_asedblst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                          <span class="n">db</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                          <span class="n">exclude_overlap_rows</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">final_filter_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">final_general_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">searchargs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">(),</span> <span class="n">searchkwargs</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">]</span><span class="o">=</span> <span class="p">()):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phase_asedb</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
        <span class="n">Rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_chemical_systems_asedblst</span><span class="p">(</span><span class="n">db_lst</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">searchargs</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">searchkwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="ow">and</span> <span class="n">exclude_overlap_rows</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_common_rows</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">Rows</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">final_filter_function</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------final filter function was provided ------------------&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">ros</span> <span class="ow">in</span> <span class="n">Rows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">Rows</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">final_filter_function</span><span class="p">,</span> <span class="n">ros</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">final_general_function</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------general function was provided ------&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">ros</span> <span class="ow">in</span> <span class="n">Rows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">Rows</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_general_function</span><span class="p">(</span><span class="n">ros</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Rows</span></div>

    <span class="k">def</span> <span class="nf">_remove_common_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">):</span>
            <span class="n">uqid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">unique_id</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">!=</span><span class="n">uqid</span><span class="p">]</span>

<div class="viewcode-block" id="MAXAnalyzer.search_sidephase_permute_chemsys_asedb"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.search_sidephase_permute_chemsys_asedb">[docs]</a>    <span class="k">def</span> <span class="nf">search_sidephase_permute_chemsys_asedb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span><span class="nb">str</span> <span class="ow">or</span> <span class="n">dBcore</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exclude_overlap_rows</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Searches for all the phases in the ase database, acting as side phase, on the basis of chemical system of MAX.</span>
<span class="sd">        It matches any chemical system that is subset of chemical system of the MAX phase. In other words, any composition,</span>
<span class="sd">        binary or ternary, is included if any elemental-combination is found in the MAX phase. The search is similar to</span>
<span class="sd">        sqlite search in ase database.</span>

<span class="sd">        :param db: str or dBcore, ase database to be searched</span>
<span class="sd">        :param exclude_overlap_rows: bool type, default True, remove the rows matching any MAX rows, based on unique_id</span>
<span class="sd">        :param args: extra search arguments, for selection/filtering, passed to the ase-sqlite searcher.</span>
<span class="sd">        :param kwargs: key-words arguments, for further filtering, passed to the ase-sqlite searcher.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phase_asedb</span>
        <span class="n">side_Rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_permute_chemical_sytems_asedb</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.set_sidephase_df"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.set_sidephase_df">[docs]</a>    <span class="k">def</span> <span class="nf">set_sidephase_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_side_phase_df</span> <span class="o">=</span> <span class="n">df</span></div>

<div class="viewcode-block" id="MAXAnalyzer.remove_overlap_asedb"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.remove_overlap_asedb">[docs]</a>    <span class="k">def</span> <span class="nf">remove_overlap_asedb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Rows</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">):</span>
                <span class="n">uqid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">unique_id</span>
                <span class="n">Rows</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">Rows</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">!=</span> <span class="n">uqid</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;MAX Rows are absent, I cannot find and remove the overlapping rows from the inputs rows&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Rows</span></div>

<div class="viewcode-block" id="MAXAnalyzer.sidephase_aserows_to_df"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.sidephase_aserows_to_df">[docs]</a>    <span class="k">def</span> <span class="nf">sidephase_aserows_to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">sp_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_aserows</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sp_species</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">decimtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;energy_per_formula&quot;</span><span class="p">:</span> <span class="s2">&quot;total_energy_per_formula&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="MAXAnalyzer.search_get_df_sp_chemsys_asedb"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.search_get_df_sp_chemsys_asedb">[docs]</a>    <span class="k">def</span> <span class="nf">search_get_df_sp_chemsys_asedb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">dBcore</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exclude_overlap_rows</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Searches and then returns a dataframe the side phases given by the chemical system of each MAX phase.</span>
<span class="sd">        It looks for ase rows in the ase database (&#39;db&#39;). exclude_overlap_rows remove rows that are matching with</span>
<span class="sd">        the MAX rows already present as rows attribute. The match is considered only if row.unique_id matches with</span>
<span class="sd">        the corresponding MAX composition row.</span>
<span class="sd">        :param db: str or dBcore instance, default None. The database of ase to perform search in.</span>
<span class="sd">        :param exclude_overlap_rows: bool type, default True, matches and removes rows that overlap with MAX rows</span>
<span class="sd">        (if found)&quot;&quot;&quot;</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_sidephase_chemsys_asedb</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">exclude_overlap_rows</span><span class="o">=</span><span class="n">exclude_overlap_rows</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sidephase_aserows_to_df</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rr</span><span class="p">])</span></div>

<div class="viewcode-block" id="MAXAnalyzer.search_get_df_sp_chemsys_asedblst"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.search_get_df_sp_chemsys_asedblst">[docs]</a>    <span class="k">def</span> <span class="nf">search_get_df_sp_chemsys_asedblst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="p">[</span><span class="n">dBcore</span><span class="p">],</span> <span class="n">exclude_overlap_rows</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">final_filter_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">final_general_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span> <span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">()):</span>

       <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_sidephase_chemsys_asedblst</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">exclude_overlap_rows</span><span class="o">=</span><span class="n">exclude_overlap_rows</span><span class="p">,</span>
                                                     <span class="n">final_filter_function</span><span class="o">=</span><span class="n">final_filter_function</span><span class="p">,</span>
                                                     <span class="n">final_general_function</span><span class="o">=</span><span class="n">final_general_function</span><span class="p">,</span>
                                                     <span class="n">searchargs</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">searchkwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>

       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sidephase_aserows_to_df</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rr</span><span class="p">])</span></div>

<div class="viewcode-block" id="MAXAnalyzer.searchset_sidephase_df"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.searchset_sidephase_df">[docs]</a>    <span class="k">def</span> <span class="nf">searchset_sidephase_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizes</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">mpkey</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_online</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">entrykwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Searches the local mongo db database by systems with sizes of 2 and 3, if the local entry is empty.</span>
<span class="sd">        The searched entries are then converted to a suitable dataframe.</span>
<span class="sd">        The method searches the online mp database (default behaviour), which can be overriden by setting the argument</span>
<span class="sd">        &#39;check_online&#39; to False.</span>
<span class="sd">        :param sizes: list default [2,3], The number of elements to use in the construction of the systems.</span>
<span class="sd">        :param mpkey: materials project key for searching online, incase of empty entry in local database</span>
<span class="sd">        :param check_online: bool, default True, whether to check the online materials project database.</span>
<span class="sd">        :param entrykwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries_by_system_database</span><span class="p">(</span><span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span> <span class="n">mpkey</span><span class="o">=</span><span class="n">mpkey</span><span class="p">,</span> <span class="n">check_online</span><span class="o">=</span><span class="n">check_online</span><span class="p">,</span> <span class="o">**</span><span class="n">entrykwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span> <span class="o">=</span> <span class="n">Entries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_side_phase_df</span><span class="p">(</span><span class="n">Entries</span><span class="o">=</span><span class="n">Entries</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.entries_by_element_database"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.entries_by_element_database">[docs]</a>    <span class="k">def</span> <span class="nf">entries_by_element_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filterfunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">entrykwargs</span><span class="p">):</span>
        <span class="n">els</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">get_entries_formula</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="o">**</span><span class="n">entrykwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">filterfunc</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span><span class="n">filterfunc</span><span class="p">,</span> <span class="n">els</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">els</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">genchesys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_genchsys</span>

<div class="viewcode-block" id="MAXAnalyzer.insert_energy_column"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.insert_energy_column">[docs]</a>    <span class="k">def</span> <span class="nf">insert_energy_column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds energy columns in the reaction dataframe. The energy column named as &#39;total_energy_per_formula&#39; is</span>
<span class="sd">        taken from side phase dataframe. This energy represents GPAW-calculated or determined (from formation energies).</span>
<span class="sd">        The method also adds MAX phase energies, present in the column &#39;energy_per_formula&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">en</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">[</span><span class="s2">&quot;total_energy_per_formula&quot;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">en</span><span class="p">)</span>
        <span class="n">en</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_df</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_df</span><span class="p">[</span><span class="s2">&quot;energy_per_formula&quot;</span><span class="p">])))</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">reactions_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">,</span> <span class="s2">&quot;reactant&quot;</span><span class="p">]:</span>
                <span class="n">reactions_df</span><span class="p">[</span><span class="s2">&quot;energy_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">reactions_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">en</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rdf_sort_columns</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_rdf_sort_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sortorder</span><span class="p">:</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sortorder</span><span class="p">:</span>
            <span class="n">sortorder</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;reactant&quot;</span><span class="p">,</span> <span class="s2">&quot;coeff_r&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_reactant&quot;</span><span class="p">,</span> <span class="s2">&quot;product&quot;</span><span class="p">,</span> <span class="s2">&quot;coeff_p&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_product&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">keylist</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="n">splitted</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sortorder</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="n">splitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">break</span>
            <span class="k">return</span> <span class="n">splitted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span>

        <span class="k">def</span> <span class="nf">keydict</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="n">splitted</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">splitted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sortorder</span><span class="p">[</span><span class="n">splitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sortorder</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">keylist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sortorder</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">keydict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;sortorder&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>

<div class="viewcode-block" id="MAXAnalyzer.calcadd_enthalpyreactions"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.calcadd_enthalpyreactions">[docs]</a>    <span class="k">def</span> <span class="nf">calcadd_enthalpyreactions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="p">[</span><span class="s2">&quot;enthalpy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Pandasutils</span><span class="o">.</span><span class="n">pd_calculate_reaction_energy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">decimtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.add_enthalpyperatom"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.add_enthalpyperatom">[docs]</a>    <span class="k">def</span> <span class="nf">add_enthalpyperatom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="p">[</span><span class="s2">&quot;enthalpy_per_atom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pandasutils</span><span class="o">.</span><span class="n">enthalpy_peratom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="p">,</span> <span class="n">decimtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">decimtol</span><span class="p">)</span></div>

<div class="viewcode-block" id="MAXAnalyzer.get_mpids"><a class="viewcode-back" href="../base.html#base.MAXAnalyzer.get_mpids">[docs]</a>    <span class="k">def</span> <span class="nf">get_mpids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mpids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">side_phases_df</span><span class="p">[</span><span class="s2">&quot;mp-id&quot;</span><span class="p">]))</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;reactant_&quot;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">get_combined_mpids</span><span class="p">(</span><span class="n">reaction_df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="p">,</span> <span class="n">mpids_dct</span><span class="o">=</span><span class="n">mpids</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_insert_mpids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mpids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mpids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactions_df</span><span class="p">[</span><span class="s2">&quot;mp-id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpids</span></div>


<div class="viewcode-block" id="calculate_total_energy_from_formation_energy"><a class="viewcode-back" href="../base.html#base.calculate_total_energy_from_formation_energy">[docs]</a><span class="k">def</span> <span class="nf">calculate_total_energy_from_formation_energy</span><span class="p">(</span><span class="n">comp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">en</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">Pycomp</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="p">{</span><span class="n">el</span><span class="p">:</span> <span class="n">elemental_energies</span><span class="p">[</span><span class="n">el</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">get_el_amt_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">energies</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">comp</span><span class="o">.</span><span class="n">refined_iupac_formula</span><span class="p">:</span> <span class="n">en</span><span class="p">})</span>
    <span class="n">deltaG</span> <span class="o">=</span> <span class="n">cohesive</span><span class="o">.</span><span class="n">get_inverse_cohesive_energy</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">deltaG</span></div>


<div class="viewcode-block" id="calculate_formation_energy"><a class="viewcode-back" href="../base.html#base.calculate_formation_energy">[docs]</a><span class="k">def</span> <span class="nf">calculate_formation_energy</span><span class="p">(</span><span class="n">comp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">en_comp</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">Pymcomp</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="o">.</span><span class="n">reduced_composition</span> <span class="o">==</span> <span class="n">Pymcomp</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="p">{</span><span class="n">el</span><span class="p">:</span> <span class="n">elemental_energies</span><span class="p">[</span><span class="n">el</span><span class="p">]</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">Pymcomp</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="o">.</span><span class="n">get_el_amt_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">energies</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">comp</span><span class="p">:</span> <span class="n">en_comp</span><span class="p">})</span>
    <span class="n">deltaG</span> <span class="o">=</span> <span class="n">cohesive</span><span class="o">.</span><span class="n">get_cohesive_energy</span><span class="p">(</span><span class="n">comp</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span> <span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">deltaG</span></div>


<div class="viewcode-block" id="get_combined_mpids"><a class="viewcode-back" href="../base.html#base.get_combined_mpids">[docs]</a><span class="k">def</span> <span class="nf">get_combined_mpids</span><span class="p">(</span><span class="n">reaction_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">mpids_dct</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reaction_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;reactant_&quot;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Considering NaN or None as obtained from ase database&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assigining -1 to phases obtained from ase database, if found&quot;</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">reaction_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
    <span class="n">mpids</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">mpids_dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># mpids[mpids.isnull()] = -1</span>
    <span class="n">mpids</span> <span class="o">=</span> <span class="n">mpids</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mpids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<span class="c1"># generate the unique combinations of input phases</span>
<div class="viewcode-block" id="iter_combine_compounds"><a class="viewcode-back" href="../base.html#base.iter_combine_compounds">[docs]</a><span class="k">def</span> <span class="nf">iter_combine_compounds</span><span class="p">(</span><span class="n">compounds</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">combinations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">necessary</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">itcombinations</span><span class="p">(</span><span class="n">compounds</span><span class="p">,</span> <span class="n">combinations</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">necessary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">comp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
            <span class="n">els</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">com</span> <span class="ow">in</span> <span class="n">comp</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;[A-Z][a-z]?&quot;</span><span class="p">,</span> <span class="n">com</span><span class="p">)}</span>
            <span class="n">els</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">els</span><span class="p">)</span>
            <span class="n">els</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">necessary</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">necessary</span><span class="p">)</span>
            <span class="n">necessary</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="c1">#          cond = [i in &quot;&quot;.join(comp) for i in necessary]</span>

            <span class="c1">#           if not all(cond):</span>
            <span class="k">if</span> <span class="n">necessary</span> <span class="o">!=</span> <span class="n">els</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">comp</span></div>


<div class="viewcode-block" id="combine_compounds_multisize"><a class="viewcode-back" href="../base.html#base.combine_compounds_multisize">[docs]</a><span class="k">def</span> <span class="nf">combine_compounds_multisize</span><span class="p">(</span><span class="n">compounds</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">combination_size</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">necessary</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combination_size</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">comps</span> <span class="ow">in</span> <span class="n">iter_combine_compounds</span><span class="p">(</span><span class="n">compounds</span><span class="p">,</span> <span class="n">combinations</span><span class="o">=</span><span class="n">comb</span><span class="p">,</span> <span class="n">necessary</span><span class="o">=</span><span class="n">necessary</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">comps</span></div>


<div class="viewcode-block" id="Pandasutils"><a class="viewcode-back" href="../base.html#base.Pandasutils">[docs]</a><span class="k">class</span> <span class="nc">Pandasutils</span><span class="p">:</span>

<div class="viewcode-block" id="Pandasutils.pd_calculate_reaction_energy"><a class="viewcode-back" href="../base.html#base.Pandasutils.pd_calculate_reaction_energy">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">pd_calculate_reaction_energy</span><span class="p">(</span><span class="n">df_series</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span>
                                     <span class="n">decimtol</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
                                     <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1">#    not_nans = df_series.notna()</span>
        <span class="c1">#    df_series = df_series[not_nans]</span>
        <span class="c1"># print(df_series)</span>
        <span class="c1"># columns = df_series.index</span>
        <span class="c1"># reactants = df_series[[&quot;reactant_{}&quot;.format(i) for i in range(0, 3)]]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">df_series</span><span class="o">.</span><span class="n">index</span>
        <span class="n">reactants</span> <span class="o">=</span> <span class="n">df_series</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;reactant&quot;</span><span class="p">)]]</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">df_series</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;product&quot;</span><span class="p">)]]</span>
        <span class="n">coeffs_r</span> <span class="o">=</span> <span class="n">df_series</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;coeff_r&quot;</span><span class="p">)]]</span>
        <span class="n">coeffs_p</span> <span class="o">=</span> <span class="n">df_series</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;coeff_p&quot;</span><span class="p">)]]</span>
        <span class="c1"># product_sum = [c * df_series[&quot;energy_product_{}&quot;.format(index.split(&quot;_&quot;)[-1])] for c, index in zip(coeffs_p,</span>
        <span class="c1">#                                                                               coeffs_p.index)]</span>
        <span class="n">product_sum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coeffs_p</span><span class="p">,</span> <span class="n">coeffs_p</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">en</span> <span class="o">=</span> <span class="n">df_series</span><span class="p">[</span><span class="s2">&quot;energy_product_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">notna</span><span class="p">(</span><span class="n">df_series</span><span class="p">[</span><span class="s2">&quot;product_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]):</span>
                <span class="k">assert</span> <span class="n">notna</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">notna</span><span class="p">(</span><span class="n">en</span><span class="p">)</span>
            <span class="n">product_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">en</span><span class="p">)</span>

        <span class="n">reactant_sum</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coeffs_r</span><span class="p">,</span> <span class="n">coeffs_r</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">en</span> <span class="o">=</span> <span class="n">df_series</span><span class="p">[</span><span class="s2">&quot;energy_reactant_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">notna</span><span class="p">(</span><span class="n">df_series</span><span class="p">[</span><span class="s2">&quot;reactant_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]):</span>
                <span class="k">assert</span> <span class="n">notna</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">notna</span><span class="p">(</span><span class="n">en</span><span class="p">)</span>
            <span class="n">reactant_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">en</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Debug:</span><span class="se">\n</span><span class="s2">Reactant index:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reactants</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">reacstr</span> <span class="o">=</span> <span class="s2">&quot;+ &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">co</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coeffs_r</span><span class="p">,</span> <span class="n">reactants</span><span class="p">)])</span>
            <span class="n">prodstr</span> <span class="o">=</span> <span class="s2">&quot;+ &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">co</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coeffs_p</span><span class="p">,</span> <span class="n">products</span><span class="p">)])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">reacstr</span> <span class="o">+</span> <span class="s2">&quot;-------&gt;&quot;</span> <span class="o">+</span> <span class="n">prodstr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;reactants energy:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reactant_sum</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;product energy: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">product_sum</span><span class="p">))</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">product_sum</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">reactant_sum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enthalpy:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">decimtol</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pandasutils.enthalpy_peratom"><a class="viewcode-back" href="../base.html#base.Pandasutils.enthalpy_peratom">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">enthalpy_peratom</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">decimtol</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">colname</span><span class="o">=</span><span class="s2">&quot;enthalpy&quot;</span><span class="p">):</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">MAXcomp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">reduced_comp</span><span class="o">.</span><span class="n">num_atoms</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;product_0&quot;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">/</span> <span class="n">numbers</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimtol</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pandasutils.filter_e_above_hull"><a class="viewcode-back" href="../base.html#base.Pandasutils.filter_e_above_hull">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">filter_e_above_hull</span><span class="p">(</span><span class="n">side_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">side_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">side_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">side_df</span><span class="p">[</span><span class="s2">&quot;e_above_hull&quot;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pandasutils.total_energyfrm_formation"><a class="viewcode-back" href="../base.html#base.Pandasutils.total_energyfrm_formation">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">total_energyfrm_formation</span><span class="p">(</span><span class="n">df_series</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                                  <span class="n">formation_colname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;formation_energy_per_formula&quot;</span><span class="p">):</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">df_series</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">]</span>
        <span class="n">pseudo_en</span> <span class="o">=</span> <span class="n">df_series</span><span class="p">[</span><span class="n">formation_colname</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">calculate_total_energy_from_formation_energy</span><span class="p">(</span><span class="n">comp</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                                                            <span class="n">en</span><span class="o">=-</span><span class="n">pseudo_en</span><span class="p">,</span>
                                                            <span class="n">elemental_energies</span><span class="o">=</span><span class="n">elemental_energies</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pandasutils.add_total_energyfrom_formation_df"><a class="viewcode-back" href="../base.html#base.Pandasutils.add_total_energyfrom_formation_df">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_total_energyfrom_formation_df</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">formation_colname</span><span class="o">=</span><span class="s2">&quot;formation_energy_per_formula&quot;</span><span class="p">):</span>

        <span class="n">En</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">total_energyfrm_formation</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="o">=</span><span class="n">elemental_energies</span><span class="p">,</span>
                      <span class="n">formation_colname</span><span class="o">=</span><span class="n">formation_colname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;total_energy_per_formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">En</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="n">En</span></div>

<div class="viewcode-block" id="Pandasutils.append_elementalenergy_df"><a class="viewcode-back" href="../base.html#base.Pandasutils.append_elementalenergy_df">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">append_elementalenergy_df</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">total_elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="n">el</span><span class="p">,</span> <span class="s2">&quot;chemsys&quot;</span><span class="p">:</span> <span class="n">el</span><span class="p">,</span> <span class="s2">&quot;total_energy_per_formula&quot;</span><span class="p">:</span> <span class="n">elemental_energies</span><span class="p">[</span><span class="n">el</span><span class="p">]}</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span>
               <span class="n">total_elements</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pandasutils.get_formation_energy_df"><a class="viewcode-back" href="../base.html#base.Pandasutils.get_formation_energy_df">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_formation_energy_df</span><span class="p">(</span><span class="n">df_series</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">en_colname</span><span class="o">=</span><span class="s2">&quot;total_energy_per_formula&quot;</span><span class="p">):</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">df_series</span><span class="p">[</span><span class="s2">&quot;phase&quot;</span><span class="p">]</span>
        <span class="n">comp_en</span> <span class="o">=</span> <span class="n">df_series</span><span class="p">[</span><span class="n">en_colname</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">calculate_formation_energy</span><span class="p">(</span><span class="n">comp</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span> <span class="n">en_comp</span><span class="o">=</span><span class="n">comp_en</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="o">=</span><span class="n">elemental_energies</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pandasutils.add_calculate_formation_energy_df"><a class="viewcode-back" href="../base.html#base.Pandasutils.add_calculate_formation_energy_df">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_calculate_formation_energy_df</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                                          <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
                                          <span class="n">elemental_energies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                                          <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                          <span class="n">en_colname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;total_energy_per_formula&quot;</span><span class="p">,</span>
                                          <span class="p">):</span>

        <span class="n">calc_energy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_formation_energy_df</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">elemental_energies</span><span class="o">=</span><span class="n">elemental_energies</span><span class="p">,</span>
                               <span class="n">en_colname</span><span class="o">=</span><span class="n">en_colname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;calc_formation_energy_pf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_energy</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">calc_energy</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Ali Muhammad Malik.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>